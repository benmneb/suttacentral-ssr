---
import '~/assets/details.css'
import { t } from '~/i18n'
import { toSentenceCase } from '~/utils/strings'
const { data: entry, parallelsOpen, userLanguage } = Astro.props

const parallelsResponse = await fetch(
  `https://suttacentral.net/api/parallels/${entry.uid}`
)
const parallelsData = await parallelsResponse.json()

// Get root translation for building links
const rootTrans = entry.translations.find((t: any) => t.is_root)

// Helper to format PTS volpages
function formatVolpages(volpages: string | null): string {
  if (!volpages) return ''
  if (!volpages.includes('PTS')) return volpages

  const parts = volpages.trim().split(', ')
  if (parts.length < 2) return volpages

  const firstParts = parts[0].trim().split(' ')
  const lastParts = parts[parts.length - 1].trim().split(' ')
  const prefix = firstParts[0]
  const firstNum = firstParts[firstParts.length - 1]
  const lastNum = lastParts[lastParts.length - 1]

  return `${prefix} ${firstNum}—${lastNum}`
}

// Helper to get base path from segment key
function getBasePath(segmentKey: string): string {
  let basePath = segmentKey
  if (segmentKey.includes('#')) {
    basePath = segmentKey.split('#')[0]
  }
  if (entry.scx_range_sutta && segmentKey.includes('-')) {
    basePath = entry.scx_range_sutta_uid
  }
  return basePath
}

// Helper to get hash fragment
function getHashFragment(key: string): string {
  if (key.includes('#')) {
    return '#' + key.split('#')[1]
  }
  return ''
}

function getParallelTypeTitle(type: string): string {
  switch (type) {
    case 'full':
      return t(userLanguage, 'suttaplex:fullParallel')
    case 'mention':
      return t(userLanguage, 'suttaplex:mention')
    case 'retelling':
      return t(userLanguage, 'suttaplex:retellingParallel')
    case 'resembling': // ¿¿what texts have this??
      return t(userLanguage, 'suttaplex:resemblingParallel')
    default:
      return ''
  }
}

// Filter out metadata entries
const segments = Object.entries(parallelsData).filter(
  ([key]) => !key.startsWith('scx_')
)
---

<details open={parallelsOpen}>
  <summary>
    {
      toSentenceCase(
        `${t(userLanguage, entry.parallel_count.length !== 1 ? 'suttaplex:countParallels' : 'suttaplex:countParallel', { count: null })} ${t(userLanguage, 'suttaplex:inAncientTexts')}`
      )
    }
    ({entry.parallel_count})
  </summary>
  <ul>
    {
      !!segments.length ? (
        segments.map(([segmentKey, parallels]) => (
          <li>
            {rootTrans ? (
              <a
                href={`/${getBasePath(segmentKey)}/${rootTrans.lang}/${rootTrans.author_uid}${getHashFragment(segmentKey)}`}
              >
                {segmentKey}
              </a>
            ) : (
              <span>{segmentKey}</span>
            )}
            <ul>
              {(parallels as any[]).map(parallel => {
                const prettyVolpages = formatVolpages(parallel.to.volpages)
                const hasTranslations = parallel.to.translations?.length > 0
                const firstTrans = parallel.to.translations?.[0]
                const displayTitle =
                  parallel.to.translated_title?.trim() ||
                  parallel.to.original_title?.trim() ||
                  parallel.to.acronym?.trim()

                return (
                  <li
                    class={`parallel-list-item-${parallel.to.type}`}
                    title={getParallelTypeTitle(parallel.to.type)}
                  >
                    {hasTranslations ? (
                      <a
                        href={`/${parallel.to.uid}/${firstTrans.lang}/${firstTrans.author_uid}${getHashFragment(parallel.to.to)}`}
                        hreflang={firstTrans.lang}
                      >
                        {displayTitle}
                      </a>
                    ) : (
                      <span>{displayTitle}</span>
                    )}

                    {/* Secondary info line */}
                    {parallel.to.translated_title &&
                    parallel.to.original_title ? (
                      <>
                        <br />
                        {parallel.to.original_title.trim()}
                        {parallel.to.acronym && (
                          <> ∙ {parallel.to.acronym.trim()}</>
                        )}
                        {prettyVolpages && <> ∙ {prettyVolpages.trim()}</>}
                      </>
                    ) : parallel.to.original_title ? (
                      <>
                        <br />
                        {parallel.to.acronym && (
                          <>{parallel.to.acronym.trim()}</>
                        )}
                        {prettyVolpages && <> ∙ {prettyVolpages.trim()}</>}
                      </>
                    ) : parallel.to.acronym && prettyVolpages ? (
                      <>
                        <br />
                        {prettyVolpages.trim()}
                      </>
                    ) : null}
                  </li>
                )
              })}
            </ul>
          </li>
        ))
      ) : (
        <li>{t(userLanguage, 'suttaplex:hasNoParallels')}</li>
      )
    }
  </ul>
</details>
