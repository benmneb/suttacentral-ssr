---
import SearchFilterContent from '~/components/search-filter-content.astro'
import SearchOptionsContent from '~/components/search-options-content.astro'
import { t } from '~/i18n'
import { getPreferredLanguage } from '~/utils/language'

interface Props {
  matchPartial?: boolean
  query?: string | null
  autoFocus?: boolean
  languageArray?: string[]
}

const {
  matchPartial = false,
  query,
  autoFocus = true,
  languageArray,
} = Astro.props
const pathname = Astro.url.pathname

const acceptLanguage = Astro.request.headers.get('accept-language')
const userLanguage = getPreferredLanguage(acceptLanguage)
---

<form action="/search" method="get" role="search">
  <fieldset>
    <label for="search-input" class="sr-only"
      >{t(userLanguage, 'search:search')}</label
    >
    <input
      id="search-input"
      type="search"
      placeholder={`${t(userLanguage, 'search:search')}‚Ä¶`}
      autocomplete="off"
      autocorrect="off"
      autocapitalize="off"
      name="query"
      required
      autofocus={autoFocus}
      value={query}
    />
    <button aria-label={t(userLanguage, 'search:search')} type="submit"
      >üîé</button
    >
  </fieldset>
  <fieldset>
    <div>
      {
        pathname !== '/search-options' && (
          <>
            <input type="checkbox" id="language-toggle" class="sr-only" />
            <label for="language-toggle" class="language-toggle-label">
              üåê
              {!!languageArray?.length && (
                <span> ({languageArray.length})</span>
              )}
              <span class="sr-only">
                {t(userLanguage, 'interface:languages')}
              </span>
            </label>
          </>
        )
      }
    </div>
    <div>
      <legend class="sr-only">{t(userLanguage, 'search:searchOptions')}</legend>
      <label>
        {t(userLanguage, 'search:matchPartial')}
        <input
          type="checkbox"
          name="matchpartial"
          value="true"
          checked={matchPartial}
        />
      </label>
      {
        pathname !== '/search-filter' && (
          <label>
            <span class="sr-only">Filter</span>
            <button
              type="button"
              popovertarget="search-filters-modal"
              aria-label={t(userLanguage, 'interface:searchFilter')}
            >
              ‚ÑπÔ∏è
            </button>
          </label>
        )
      }
    </div>
    <SearchOptionsContent />
  </fieldset>
</form>

{
  pathname !== '/search-filter' && (
    <section id="search-filters-modal" popover>
      <SearchFilterContent />
    </section>
  )
}

<style>
  form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;

    fieldset:first-of-type {
      display: flex;
      flex: 1;
      margin: 0;
      padding: 0.4rem;
      border: 1px solid;
      border-radius: var(--rounding);
      border-color: var(--bg-alt-4);

      &:focus-within {
        border-color: inherit;
      }

      input {
        width: 100%;
        border: none;
        background-color: inherit;
        color: inherit;
        font-size: large;

        &:focus {
          outline: none;
        }
      }

      button {
        border: none;
        background: none;
        font-size: inherit;
        cursor: pointer;
      }
    }

    > label {
      display: flex;
      align-items: center;
      align-self: end;
      gap: 0.25rem;
      white-space: nowrap;
      cursor: pointer;
    }

    fieldset:nth-of-type(2) {
      border: none;
      padding: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 0.5rem;
      color: var(--text-color-secondary);

      button {
        border: none;
        background: none;
        cursor: pointer;
        border-radius: var(--rounding);
        font-size: inherit;
        padding: 0 0.2rem;

        &:hover {
          background-color: var(--primary-color);
        }
      }

      .language-toggle-label {
        cursor: pointer;
        /* border-radius: var(--rounding); */
        /* padding: 0 0.2rem; */

        &:hover {
          background-color: var(--primary-color);
          color: var(--background-color);
        }
      }

      > :global(fieldset) {
        width: 100%;
      }

      &:has(#language-toggle) > :global(fieldset#search-options) {
        display: none;
      }

      &:has(#language-toggle:checked) > :global(fieldset#search-options) {
        display: block;
      }
    }
  }
</style>

<script>
  'use strict'

  const popover = document.getElementById('search-modal')

  document.addEventListener('keydown', function (event) {
    if (popover && (event.metaKey || event.ctrlKey) && event.key === 'k') {
      event.preventDefault()
      popover.togglePopover()
    }
  })

  // For the Windows 7 + Chrome 109 clan
  if (!('popover' in HTMLElement.prototype)) {
    const searchButton = document.querySelector(
      'button[popovertarget="search-modal"]'
    )
    if (searchButton) {
      searchButton.addEventListener('click', event => {
        event.preventDefault()
        window.location.href = '/search'
      })
    }
  }
</script>
