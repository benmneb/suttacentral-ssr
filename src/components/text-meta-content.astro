---
import '~/assets/details.css'
import '~/assets/text-meta-content.css'
import Heading, { type HeadingProps } from '~/components/heading.astro'
import { t } from '~/i18n'
import { toSentenceCase, uidToAcronym } from '~/utils/strings'
import ParallelsDetails from './parallels-details.astro'

interface Props {
  data: any // suttaplex response
  userLanguage?: string
  title?: string
  translations?: any
  parallelsOpen?: boolean
  headingLevel?: HeadingProps['level']
  isIndividualRangeSutta?: boolean
  inRangeSuttaId?: string
}

const {
  data: entry,
  userLanguage = 'en',
  parallelsOpen,
  headingLevel,
  isIndividualRangeSutta = false,
  inRangeSuttaId,
} = Astro.props

const translations = entry.translations.filter(t => t.lang === userLanguage)
const otherTranslations = entry.translations.filter(
  t => t.lang !== userLanguage && t.lang !== entry.root_lang
)
const rootTexts = entry.translations.filter(t => t.lang === entry.root_lang)

const alignedHTML = `<span title="${t(userLanguage, 'suttaplex:aligned')}: ${t(userLanguage, 'suttaplex:alignedDescription')}" role="icon">üîó</span>`
const annotatedHTML = `<span title="${t(userLanguage, 'suttaplex:annotated')}: ${t(userLanguage, 'suttaplex:annotatedDescription')}" role="icon">üìù</span>`

function translationHref(translation) {
  const uid =
    isIndividualRangeSutta && translation.segmented ? inRangeSuttaId : entry.uid
  return `/${uid}/${translation.lang}/${translation.author_uid}`
}

function printIconsHTML(translation) {
  const icons = [
    translation.segmented && alignedHTML,
    translation.has_comment && annotatedHTML,
  ]
    .filter(Boolean)
    .join(' ')

  return icons ? ` ${icons}` : ''
}
---

<article>
  <hgroup>
    <Heading level={headingLevel}>
      {
        isIndividualRangeSutta
          ? inRangeSuttaId?.startsWith('an')
            ? uidToAcronym(inRangeSuttaId!)
            : entry.title || uidToAcronym(inRangeSuttaId!)
          : entry.original_title &&
              entry.translated_title &&
              entry.original_title !== entry.translated_title
            ? `${entry.original_title}‚Äî${entry.translated_title}`
            : entry.translated_title || entry.original_title
      }
    </Heading>
    {!!entry.acronym && !isIndividualRangeSutta && <p>{entry.acronym}</p>}
  </hgroup>
  {!!entry.blurb && <p set:html={entry.blurb} />}
  <section>
    {
      !!entry.translations.length && (
        <>
          <details open>
            <summary>
              {toSentenceCase(
                `${t(userLanguage, translations.length !== 1 ? 'suttaplex:translationsIn' : 'suttaplex:translationIn')} ${t(userLanguage, translations.length !== 1 ? 'suttaplex:inYourLanguage' : 'suttaplex:inYourLanguage')}`
              )}
            </summary>
            <ul>
              {translations.map(t => (
                <li
                  set:html={`${t.lang_name}‚Äî<a href="${translationHref(t)}">${(t.author || t.author_uid)?.trim()}</a> ${t.publication_date ? `(${t.publication_date})` : ''}${printIconsHTML(t)}`}
                />
              ))}
            </ul>
          </details>
          <details open>
            <summary>
              {toSentenceCase(
                `${t(userLanguage, rootTexts.length !== 1 ? 'suttaplex:editions' : 'suttaplex:edition')} ${t(userLanguage, translations.length !== 1 ? 'suttaplex:ofRootText' : 'suttaplex:ofRootText')}`
              )}
            </summary>
            <ul>
              {rootTexts.map(t => (
                <li
                  set:html={`${t.lang_name}‚Äî<a href="${translationHref(t)}">${(t.author || t.author_uid)?.trim()}</a> ${t.publication_date ? `(${t.publication_date})` : ''}`}
                />
              ))}
            </ul>
          </details>
          <details>
            <summary>
              {toSentenceCase(
                `${t(userLanguage, otherTranslations.length !== 1 ? 'suttaplex:translationsIn' : 'suttaplex:translationIn')} ${t(userLanguage, otherTranslations.length !== 1 ? 'suttaplex:inModernLanguages' : 'suttaplex:inModernLanguages')}`
              )}{' '}
              ({otherTranslations.length})
            </summary>
            <ul>
              {otherTranslations
                .toSorted((a, b) => a.lang - b.lang)
                .map(t => (
                  <li
                    set:html={`${t.lang_name}‚Äî<a href="${translationHref(t)}">${t.author}</a> ${t.publication_date ? `(${t.publication_date})` : ''}${printIconsHTML(t)}`}
                  />
                ))}
            </ul>
          </details>
        </>
      )
    }
    {
      (entry.type === 'leaf' || entry.uid.startsWith('pli-tv-')) && (
        <ParallelsDetails
          data={entry}
          parallelsOpen={parallelsOpen || !entry.translations.length}
          userLanguage={userLanguage}
          isIndividualRangeSutta={isIndividualRangeSutta}
          inRangeSuttaId={inRangeSuttaId}
        />
      )
    }
  </section>
</article>
