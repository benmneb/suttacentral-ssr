---
import '~/assets/map.css'
import '~/assets/figure.css'
import '~/assets/details.css'
import RelatedPages from '~/components/related-pages.astro'
import { t } from '~/i18n'
import Layout from '~/layouts/Layout.astro'
import { getPreferredLanguage } from '~/utils/language'
import { icon } from '~/constants/icons'

const acceptLanguage = Astro.request.headers.get('accept-language')
const userLanguage = getPreferredLanguage(acceptLanguage)

const title = t(userLanguage, 'map:1')
const crumbsData = [{ title }]

let features: any[] = []
let layerNames: string[] = []

try {
  const res = await fetch('https://suttacentral.net/api/map_data')
  const data = await res.json()
  const geoJSON = data[0]
  features = geoJSON.features || []

  // Extract unique layer names preserving order
  const seenLayers = new Set<string>()
  for (const f of features) {
    if (f.properties?.layer && !seenLayers.has(f.properties.layer)) {
      seenLayers.add(f.properties.layer)
      layerNames.push(f.properties.layer)
    }
  }
} catch (e) {
  console.error('Failed to fetch map data:', e)
}

const layerTranslations: Record<string, string> = {
  'Capital cities': 'map:5',
  'Towns & villages': 'map:6',
  'Temples & features': 'map:7',
  Regions: 'map:8',
  Mahajanapadas: 'map:9',
  'Republics / countries': 'map:10',
  'Mah훮parinibb훮na journey': 'map:11',
  'P훮r훮yanavagga journey': 'map:12',
  'Extraterrestrial Places': 'map:13',
}

function getLayerLabel(layerName: string): string {
  const key = layerTranslations[layerName]
  return key ? t(userLanguage, key) : layerName
}
---

<Layout title={title} breadcrumbs={crumbsData}>
  <RelatedPages category="misc" />
  <main>
    <article>
      <h1 set:html={t(userLanguage, 'map:1')} />

      <section aria-labelledby="static-map-heading">
        <h2 id="static-map-heading" set:html={t(userLanguage, 'map:2')} />
        <figure>
          <picture>
            <source
              srcset="https://suttacentral.net/img/static-pages/jambudipa_map.avif"
              type="image/avif"
            />
            <img
              alt="Hand-drawn map of Jambudipa"
              class="image-home"
              src="https://suttacentral.net/img/static-pages/jambudipa_map.jpg"
              width="1476"
            />
          </picture>
          <figcaption set:html={t(userLanguage, 'map:3')} />
        </figure>
      </section>

      <section aria-labelledby="interactive-map-heading">
        <h2 id="interactive-map-heading" set:html={t(userLanguage, 'map:4')} />
        <noscript>
          <p>{t(userLanguage, 'interface:noScript')}</p>
        </noscript>
        <sc-map></sc-map>
      </section>

      <section aria-labelledby="places-index-heading">
        <h2 id="places-index-heading">
          {t(userLanguage, 'map:indexOfPlaces')}
        </h2>
        {
          layerNames.map(layerName => {
            const layerFeatures = features
              .filter(f => f.properties?.layer === layerName)
              .sort((a, b) =>
                (a.properties?.name || '').localeCompare(
                  b.properties?.name || ''
                )
              )

            return (
              <details>
                <summary>{getLayerLabel(layerName)}</summary>
                <ul>
                  {layerFeatures.map(f => (
                    <li>
                      {f.properties?.define ? (
                        <>
                          <span set:html={icon.marker[f.properties.icon]} />
                          <a href={`/define/${f.properties.define}`}>
                            {f.properties.name}
                          </a>
                        </>
                      ) : (
                        f.properties?.name
                      )}
                    </li>
                  ))}
                </ul>
              </details>
            )
          })
        }
      </section>
    </article>
  </main>

  <script>
    import '~/components/sc-map.ts'
  </script>
</Layout>
