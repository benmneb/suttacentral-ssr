---
import '../assets/search.css'
import SearchForm from '../components/search-form.astro'
import TextMetaContent from '../components/text-meta-content.astro'
import Layout from '../layouts/Layout.astro'

const { searchParams } = Astro.url

const query = searchParams.get('query') // TODO: handle no query
const siteLanguage = 'en' // TODO: lol
const matchPartial = false // TODO: add checkbox and param
const limit = 50 // Show 50 results to start with, like .net
const page = Number(searchParams.get('page')) || 1
const offset = (page - 1) * limit

const searchResponse = await fetch(
  `https://suttacentral.net/api/search/instant?limit=${limit}&offset=${offset}&query=${query}&language=${siteLanguage}&restrict=all&matchpartial=${matchPartial}`
)
const searchData = await searchResponse.json()

const hits = searchData.hits.filter(h => h.category !== 'dictionary')
const dictionaryHits = searchData.hits.filter(h => h.category === 'dictionary')
const suttaplexHits = searchData.suttaplex

const hasMore = searchData.total > page * limit
const hasPrevious = page > 1

const dictionaryTitles = {
  ncped: 'New Concise Pali English Dictionary',
  cped: 'Concise Pali English Dictionary',
  dhammika: 'Nature and the Environment in Early Buddhism by S. Dhammika',
  dppn: 'Dictionary of Pali Proper Names',
  pts: 'PTS Pali English Dictionary',
  dpd: 'Digital Pāḷi Dictionary',
  ddb: 'Digital Dictionary of Buddhism',
}
---

<Layout>
  <main>
    <h1>Search</h1>
    <p>{searchData.total} results for <b>{query}</b></p>
    <SearchForm />
    <section>
      {
        !!hits.length && (
          <ol>
            {hits.map(hit => (
              <li>
                <a href={hit.url}>
                  <h2>
                    {hit.root_name}—{hit.name}
                  </h2>
                </a>
                <p>
                  {hit.acronym} ∙ {hit.full_lang} ∙ {hit.author}
                </p>
                {hit.highlight.content.map(excerpt => (
                  <span set:html={excerpt} />
                ))}
              </li>
            ))}
          </ol>
        )
      }
      {
        (!!dictionaryHits.length || !!suttaplexHits.length) && (
          <ol>
            {!!dictionaryHits.length &&
              dictionaryHits.map(hit => (
                <details>
                  <summary>Define {query}</summary>
                  <article>
                    <p>
                      <span>
                        {dictionaryTitles?.[hit.highlight.detail[0].dictname] ||
                          'Dictionary'}
                      </span>
                      <a href={hit.url}>(see more (TODO))</a>
                    </p>
                    <h2>{hit.highlight.detail[0].word}</h2>
                    <p>
                      <em>{hit.highlight.detail[0].grammar}</em>
                    </p>
                    <ol>
                      {hit.highlight.detail[0].definition.map(d => (
                        <li>{d}</li>
                      ))}
                    </ol>
                  </article>
                </details>
              ))}
            {!!suttaplexHits.length &&
              suttaplexHits.map(entry => (
                <TextMetaContent data={entry} chosenLanguage={siteLanguage} />
              ))}
          </ol>
        )
      }
    </section>
    <nav aria-label="Search pagination">
      <div>
        {
          hasPrevious && (
            <form method="GET" action="/search">
              <input type="hidden" name="query" value={query} />
              <input type="hidden" name="page" value={page - 1} />
              <button type="submit">← Previous</button>
            </form>
          )
        }
      </div>
      <div>
        {
          hasMore && (
            <form method="GET" action="/search">
              <input type="hidden" name="query" value={query} />
              <input type="hidden" name="page" value={page + 1} />
              <button type="submit">Next →</button>
            </form>
          )
        }
      </div>
    </nav>
  </main>
</Layout>
