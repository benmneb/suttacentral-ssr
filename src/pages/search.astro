---
import '~/assets/search.css'
import SearchForm from '~/components/search-form.astro'
import TextMetaContent from '~/components/text-meta-content.astro'
import { dictionaryTitles } from '~/constants/define'
import { t } from '~/i18n'
import Layout from '~/layouts/Layout.astro'
import { getPreferredLanguage } from '~/utils/language'

const { searchParams } = Astro.url
const acceptLanguage = Astro.request.headers.get('accept-language')
const userLanguage = getPreferredLanguage(acceptLanguage)

const query = searchParams.get('query')
const matchPartial = searchParams.get('matchpartial') === 'true'
const limit = 50 // SC default (apparently limiting something other than the results count)
const page = Number(searchParams.get('page')) || 1
const offset = (page - 1) * limit

let hits = []
let dictionaryHits = []
let suttaplexHits = []
let hasMore = false
let hasPrevious = false
let searchData = { total: 0 }

if (query) {
  const searchResponse = await fetch(
    `https://suttacentral.net/api/search/instant?limit=${limit}&offset=${offset}&query=${query}&language=${userLanguage}&restrict=all&matchpartial=${matchPartial}`
  )
  searchData = await searchResponse.json()

  hits = searchData.hits.filter(h => h.category !== 'dictionary')
  dictionaryHits = searchData.hits.filter(h => h.category === 'dictionary')
  suttaplexHits = searchData.suttaplex

  hasMore = searchData.total > page * limit
  hasPrevious = page > 1
}
---

<Layout title="Search" noindex>
  <main>
    <hgroup>
      <h1>{t(userLanguage, 'search:search')}</h1>
      {
        query && (
          <p>
            {searchData.total.toLocaleString()}
            {t(userLanguage, 'search:resultsFor')}
            <b>{query}</b>
          </p>
        )
      }
    </hgroup>
    <SearchForm
      matchPartial={matchPartial}
      query={query}
      autoFocus={!query || !searchData.total}
    />
    {
      query && (
        <>
          <section>
            {!!hits.length && (
              <ol>
                {hits.map(hit => (
                  <li>
                    <hgroup>
                      <h2>
                        <a href={hit.url}>
                          {hit.root_name}—{hit.name}
                        </a>
                      </h2>
                      <p>
                        {[hit.acronym, hit.full_lang, hit.author]
                          .filter(Boolean)
                          .join(' ∙ ')}
                      </p>
                    </hgroup>
                    {hit.highlight.content.map((excerpt: string) => (
                      <span
                        set:html={excerpt.replaceAll('target="_blank"', '')}
                      />
                    ))}
                    {hit.all_reference
                      ?.split(',')
                      .map((ref: string, idx: number, arr: string[]) => (
                        <span>
                          {/* TODO: */}
                          <a href={`${hit.url}/en/sujato#${ref.trim()}`}>
                            {ref}
                          </a>
                          {idx !== arr.length - 1 && '∙ '}
                        </span>
                      ))}
                  </li>
                ))}
              </ol>
            )}
            {(!!dictionaryHits.length || !!suttaplexHits.length) && (
              <ol>
                {!!dictionaryHits.length &&
                  dictionaryHits.map(hit => (
                    <li>
                      <dl>
                        <dt>{hit.highlight.detail[0].word}</dt>
                        <dd>
                          <small>
                            {
                              dictionaryTitles?.[
                                hit.highlight.detail[0].dictname
                              ]
                            }
                          </small>
                        </dd>
                        {hit.highlight.detail[0].grammar && (
                          <dd>
                            <em>{hit.highlight.detail[0].grammar}</em>
                          </dd>
                        )}
                        {hit.highlight.detail[0].text && (
                          <dd
                            set:html={hit.highlight.detail[0].text.replaceAll(
                              'https://suttacentral.net',
                              ''
                            )}
                          />
                        )}
                        {hit.highlight.detail[0].definition && (
                          <dd>
                            {Array.isArray(
                              hit.highlight.detail[0].definition
                            ) ? (
                              <ol>
                                {hit.highlight.detail[0].definition.map(d => (
                                  <li set:html={d} />
                                ))}
                              </ol>
                            ) : (
                              hit.highlight.detail[0].definition
                            )}
                          </dd>
                        )}
                        {hit.highlight.detail[0].xr && (
                          <dd>
                            <ul>
                              {Array.isArray(hit.highlight.detail[0].xr) ? (
                                <>
                                  {hit.highlight.detail[0].xr.map(d => (
                                    <li>
                                      <a href={`/define/${d}`}>{d}</a>
                                    </li>
                                  ))}
                                </>
                              ) : (
                                <li>
                                  <a
                                    href={`/define/${hit.highlight.detail[0].xr}`}
                                  >
                                    {hit.highlight.detail[0].xr}
                                  </a>
                                </li>
                              )}
                            </ul>
                          </dd>
                        )}
                        {hit.highlight.detail[0].pronunciation && (
                          <dd>
                            <strong>Pronunciation:</strong>{' '}
                            {hit.highlight.detail[0].pronunciation}
                          </dd>
                        )}
                      </dl>
                      <p>
                        <a href={hit.url}>
                          {t(userLanguage, 'search:all')}{' '}
                          {t(userLanguage, 'search:dictionaries')} →
                        </a>
                      </p>
                    </li>
                  ))}
                {!!suttaplexHits.length &&
                  suttaplexHits.map(entry => (
                    <li>
                      <TextMetaContent
                        data={entry}
                        userLanguage={userLanguage}
                      />
                    </li>
                  ))}
              </ol>
            )}
          </section>
          <nav aria-label="Search pagination">
            <div>
              {hasPrevious && (
                <form method="GET" action="/search">
                  <input type="hidden" name="query" value={query} />
                  <input type="hidden" name="page" value={page - 1} />
                  {matchPartial && (
                    <input type="hidden" name="matchpartial" value="true" />
                  )}
                  <button type="submit">
                    ← {t(userLanguage, 'interface:previous')}
                  </button>
                </form>
              )}
            </div>
            <div>
              {hasMore && (
                <form method="GET" action="/search">
                  <input type="hidden" name="query" value={query} />
                  <input type="hidden" name="page" value={page + 1} />
                  {matchPartial && (
                    <input type="hidden" name="matchpartial" value="true" />
                  )}
                  <button type="submit">
                    {t(userLanguage, 'interface:next')} →
                  </button>
                </form>
              )}
            </div>
          </nav>
        </>
      )
    }
  </main>
</Layout>

<style>
  main {
    max-width: var(--content-double-width-gap);

    & > section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;

      ol {
        min-width: 0;
        overflow-wrap: break-word;

        &:nth-of-type(2) {
          list-style-type: disc;
        }
      }
    }

    & > nav {
      display: flex;
      justify-content: space-between;
    }
  }
</style>
