---
import '~/assets/define.css'
import { dictionaryTitles } from '~/constants/define'
import { t } from '~/i18n'
import Layout from '~/layouts/Layout.astro'
import { getPreferredLanguage } from '~/utils/language'

// Handle form submissions: /define/?term=X â†’ /define/X
const queryTerm = Astro.url.searchParams.get('term')
if (queryTerm) {
  return Astro.redirect(`/define/${queryTerm}`)
}

const { term } = Astro.params
const acceptLanguage = Astro.request.headers.get('accept-language')
const userLanguage = getPreferredLanguage(acceptLanguage)

let dictionaryData = []
let similarData = [[]]
let adjacentData = [[]]

if (term) {
  const dictionaryResponse = await fetch(
    `https://suttacentral.net/api/dictionary_full/${term}?language=${userLanguage}`
  )
  dictionaryData = await dictionaryResponse.json()

  const similarResponse = await fetch(
    `https://suttacentral.net/api/dictionary_full/similar/${term}?language=${userLanguage}`
  )
  similarData = await similarResponse.json()

  const adjacentResponse = await fetch(
    `https://suttacentral.net/api/dictionary_full/adjacent/${term}?language=${userLanguage}`
  )
  adjacentData = await adjacentResponse.json()
}
---

<Layout
  title={term
    ? `${t(userLanguage, 'dictionary:dictionaryResultsText')} ${term}`
    : t(userLanguage, 'dictionary:define')}
  description={term && dictionaryData[0]?.definition
    ? (Array.isArray(dictionaryData[0].definition)
        ? dictionaryData[0].definition[0]
        : dictionaryData[0].definition
      ).replace(/<[^>]*>/g, '')
    : t(userLanguage, 'dictionary:description')}
>
  <main>
    <hgroup>
      <h1>{t(userLanguage, 'dictionary:define')}</h1>
      {
        term && (
          <p>
            {dictionaryData.length.toLocaleString()}
            {t(
              userLanguage,
              dictionaryData.length !== 1
                ? 'search:resultsFor'
                : 'search:resultsFor'
            )}
            <b>{term}</b>
          </p>
        )
      }
    </hgroup>
    <section>
      {
        !!dictionaryData.length && (
          <article>
            {dictionaryData.map(entry => (
              <dl>
                <dt>{entry.word || entry.entry}</dt>
                <dd>
                  <small>
                    {dictionaryTitles?.[entry.dictname]}{' '}
                    {entry.dictname === 'dpd' && (
                      <a href={`https://dpdict.net/?q=${term}`}>
                        [{t(userLanguage, 'dictionary:link')}]
                      </a>
                    )}
                  </small>
                </dd>
                {entry.grammar && (
                  <dd>
                    <em>{entry.grammar}</em>
                  </dd>
                )}
                {entry.text && (
                  <dd
                    set:html={entry.text.replaceAll(
                      'https://suttacentral.net',
                      ''
                    )}
                  />
                )}
                {entry.definition && (
                  <dd>
                    {Array.isArray(entry.definition) ? (
                      <ol>
                        {entry.definition.map(d => (
                          <li set:html={d} />
                        ))}
                      </ol>
                    ) : (
                      entry.definition
                    )}
                  </dd>
                )}
                {entry.xr && (
                  <dd>
                    <ul>
                      {Array.isArray(entry.xr) ? (
                        <>
                          {entry.xr.map(d => (
                            <li>
                              <a href={`/define/${d}`}>{d}</a>
                            </li>
                          ))}
                        </>
                      ) : (
                        <li>
                          <a href={`/define/${entry.xr}`}>{entry.xr}</a>
                        </li>
                      )}
                    </ul>
                  </dd>
                )}
                {entry.pronunciation && (
                  <dd>
                    <strong>
                      {t(userLanguage, 'dictionary:pronunciation')}
                    </strong>{' '}
                    {entry.pronunciation}
                  </dd>
                )}
              </dl>
            ))}
          </article>
        )
      }
      <nav>
        <form action="/define" method="get">
          <input
            type="search"
            name="term"
            required
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            placeholder={t(userLanguage, 'dictionary:searchPlaceholder')}
          />
          <button
            aria-label={t(userLanguage, 'dictionary:define')}
            type="submit">ðŸ”Ž</button
          >
        </form>
        {
          !!adjacentData?.[0].length && !!dictionaryData.length && (
            <article>
              <h2>{t(userLanguage, 'dictionary:adjacentTerms')}</h2>
              <ol>
                {adjacentData[0].map(adjacentTerm =>
                  adjacentTerm === term ? (
                    <li>
                      <span>{adjacentTerm}</span>
                    </li>
                  ) : (
                    <li>
                      <a href={`/define/${adjacentTerm}`}>{adjacentTerm}</a>
                    </li>
                  )
                )}
              </ol>
            </article>
          )
        }
        {
          !!similarData?.[0].length && (
            <article>
              <h2>{t(userLanguage, 'dictionary:similarSpelling')}</h2>
              <ol>
                {similarData[0].map(similarTerm => (
                  <li>
                    <a href={`/define/${similarTerm}`}>{similarTerm}</a>
                  </li>
                ))}
              </ol>
            </article>
          )
        }
      </nav>
    </section>
  </main>
</Layout>

<style>
  main {
    max-width: calc(var(--content-max-width) + 30ch);

    & > section {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: start;
      gap: 1rem;

      @media (max-width: 600px) {
        grid-template-columns: 1fr;
      }

      & > section {
        max-width: var(--content-max-width);
      }

      & > nav {
        position: sticky;
        top: 1rem;
        max-width: 30ch;

        h2 {
          overflow-wrap: break-word;
        }
      }
    }
  }

  form {
    display: flex;
    border: 1px solid;
    padding: 0.4rem;
    border-radius: var(--rounding);
    border-color: var(--bg-alt-4);

    &:focus-within {
      border-color: inherit;
    }

    input {
      width: 100%;
      border: none;
      background-color: inherit;
      color: inherit;
      font-size: inherit;

      &:focus {
        outline: none;
      }
    }

    button {
      border: none;
      background: none;
      font-size: inherit;
      cursor: pointer;
    }
  }
</style>

<script>
  if (document.querySelector('sc-map')) {
    import('~/components/sc-map')
  }
</script>
