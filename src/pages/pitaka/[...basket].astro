---
import { t } from '~/i18n'
import Layout from '~/layouts/Layout.astro'
import { generatePitakaJsonLd } from '~/utils/json-ld'
import { getPreferredLanguage } from '~/utils/language'

const { pathname } = Astro.url
const uid = pathname?.split('/').pop()

const acceptLanguage = Astro.request.headers.get('accept-language')
const userLanguage = getPreferredLanguage(acceptLanguage)

const response = await fetch(
  `https://suttacentral.net/api/menu/${uid}?language=${userLanguage}`
)
const json = await response.json()
let data = json[0]

const newKids = await Promise.all(
  data.children.map(async child => {
    const response = await fetch(
      `https://suttacentral.net/api/menu/${child.uid}?language=${userLanguage}`
    )
    const json = await response.json()
    const childData = json[0]

    const hasBranchChildren = childData.children?.some(
      gc => gc.node_type === 'branch'
    )
    const isPatimokkha = child.uid.endsWith('-pm')

    if (!hasBranchChildren || isPatimokkha) {
      return { ...child, scn_href: `/${child.uid}` }
    }
    return child
  })
)
data.children = newKids

const crumbsResponse = await fetch(
  `https://suttacentral.net/api/navigation_data/${uid}?language=${userLanguage}`
)
const crumbsData = await crumbsResponse.json()

const shortcutsResponse = await fetch(`https://suttacentral.net/api/shortcuts`)
const shortcutsData = await shortcutsResponse.json()

const origin = Astro.site?.origin ?? ''
const jsonLd = generatePitakaJsonLd(data, crumbsData, origin)
---

<Layout breadcrumbs={crumbsData} jsonLd={jsonLd}>
  <main>
    <h1
      set:text={`${data.root_name}${data.root_name && data.translated_name ? '—' : ''}${data.translated_name || ''}`}
    />
    {!!data.blurb && <p set:html={data.blurb} />}
    <ol>
      {
        data.children.map(child => (
          <li>
            <h2>
              <a
                href={child.scn_href ?? `${data.uid}/${child.uid}`}
                set:text={`${child.root_name}${child.root_name && child.translated_name ? '—' : ''}${child.translated_name || ''}`}
              />
            </h2>
            {!!child.blurb && <p set:html={child.blurb} />}
            {shortcutsData?.[0]?.shortcuts?.includes(child.uid) && (
              <p>
                <a href={`/${child.uid}`}>
                  {t(userLanguage, 'interface:shortcutToFullList')} →
                </a>
              </p>
            )}
          </li>
        ))
      }
    </ol>
  </main>
</Layout>

<style>
  ol {
    list-style-type: upper-roman;
  }
</style>
