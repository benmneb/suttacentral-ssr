---
import '../assets/text.css'
import PublicationInfo from '../components/publication-info.astro'
import TextMetaContent from '../components/text-meta-content.astro'
import Layout from '../layouts/Layout.astro'

const { text } = Astro.params
const siteLanguage = 'en' // TODO: lol

const parts = text!.split('/') // will be a string like "dn1/en/sujato"
if (parts.length !== 3) return Astro.redirect('/404') // TODO:
const [acronym, language, authorUid] = parts

const bilaraResponse = await fetch(
  `https://suttacentral.net/api/bilarasuttas/${acronym}/${authorUid}?lang=${language}`
)
const bilaraData = await bilaraResponse.json()

const suttasResponse = await fetch(
  `https://suttacentral.net/api/suttas/${acronym}/${authorUid}?lang=${language}&siteLanguage=${siteLanguage}`
)
const suttasData = await suttasResponse.json()

const suttaplexResponse = await fetch(
  `https://suttacentral.net/api/suttaplex/${acronym}?language=${siteLanguage}`
)
const suttaplexData = await suttaplexResponse.json()

const publicationResponse = await fetch(
  `https://suttacentral.net/api/publication_info/${acronym}/${language}/${authorUid}`
)
const publicationData = await publicationResponse.json()

const crumbsResponse = await fetch(
  `https://suttacentral.net/api/navigation_data/${acronym}?language=${siteLanguage}`
)
const crumbsData = await crumbsResponse.json()

const isSegmented = !!suttasData.segmented
const isRootText = language === suttaplexData[0].root_lang

let commentsHtml = ''

function getRootLangHTML() {
  if (!isSegmented || !isRootText) return null

  return bilaraData.keys_order
    .map(key => {
      const html = bilaraData.html_text[key]
      const text = bilaraData.root_text[key]
      const comment = bilaraData.variant_text?.[key]
      const ref = key.split(':').pop()

      if (!html) return ''

      const segment = `
    <span id="${key}" class="segment">
      <span class="reference" id="${ref}">
        <a href="#${ref}" title="SuttaCentral segment number">${ref}</a>
      </span>
      ${
        text
          ? `
      <!-- This is not a translation, its the root text, the class is so it's not \`display: none\` by default. -->
      <span class="translation" lang="${suttasData.root_text.lang}" translate="no">
        <span class="text">${text}</span>
        ${
          comment
            ? `
        <button popovertarget="comment-${key}" aria-label="Show variant reading for segment ${ref}">*</button>
        <span class="inline-comment" aria-label="Variant reading for segment ${ref}">
          Variant: ${comment.replace(/https:\/\/suttacentral\.net/g, '')}
        </span>
        `
            : ''
        }
      </span>
      `
          : ''
      }
    </span>
  `

      if (comment) {
        commentsHtml += `
      <article id="comment-${key}" popover>
        Variant: ${comment.replace(/https:\/\/suttacentral\.net/g, '')}
      </article>
    `
      }

      return html.replace('{}', segment)
    })
    .join('')
}

function getSegmentedHTML() {
  if (!isSegmented || isRootText) return null

  return bilaraData.keys_order
    .map(key => {
      const html = bilaraData.html_text[key]
      const text = bilaraData.translation_text[key]
      const rootText = bilaraData.root_text[key]
      const comment = bilaraData.comment_text?.[key]
      const ref = key.split(':').pop()

      if (!html) return ''

      const segment = `
    <span id="${key}" class="segment">
      <span class="reference" id="${ref}">
        <a href="#${ref}" title="SuttaCentral segment number">${ref}</a>
      </span>
      ${
        text
          ? `
      <span class="translation" lang="${suttasData.translation.lang}">
        <span class="text">${text}</span>
        ${
          comment
            ? `
        <button popovertarget="comment-${key}" aria-label="Show ${suttasData.translation.author}'s footnote for segment ${key}">*</button>
        <span class="inline-comment" aria-label="${suttasData.translation.author}'s footnote for segment ${key}">
          ${comment.replace(/https:\/\/suttacentral\.net/g, '')}
        </span>
        `
            : ''
        }
      </span>
      `
          : ''
      }
      ${
        rootText
          ? `
      <span class="root" lang="${suttasData.suttaplex.root_lang}" translate="no">
        <span class="text">${rootText}</span>
      </span>
      `
          : ''
      }
    </span>
  `

      if (comment) {
        commentsHtml += `
      <article id="comment-${key}" popover>
        ${comment.replace(/https:\/\/suttacentral\.net/g, '')}
      </article>
    `
      }

      return html.replace('{}', segment)
    })
    .join('')
}

function getLegacyHTML() {
  if (isSegmented) return null

  const htmlContent = suttasData?.translation.text.replace(/\n/g, '')
  // Extract the last <footer>...</footer> (its the publication info)
  const footerParts = htmlContent.split('<footer')
  const lastFooterPart = footerParts[footerParts.length - 1]
  const footerContent = lastFooterPart.split('</footer>')[0]
  const originalFooter = '<footer' + footerContent + '</footer>'
  // Remove footer from HTML
  const htmlWithoutFooter = htmlContent.replace(originalFooter, '')
  // Transform footer to info article with popover
  const modifiedFooter = originalFooter
    .replace('<footer', '<article id="info" popover')
    .replace('</footer>', '</article>')

  return htmlWithoutFooter + modifiedFooter
}

const rootLangHTML = getRootLangHTML()
const segmentedHTML = getSegmentedHTML()
const legacyHTML = getLegacyHTML()

const articleHTML = rootLangHTML || segmentedHTML || legacyHTML
---

<Layout breadcrumbs={crumbsData}>
  <main>
    <aside>
      <fieldset>
        <ul>
          <li>
            <button
              popovertarget="info"
              aria-label="Show publication information"
            >
              Info
            </button>
          </li>
          <li>
            <button
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="views-menu"
              aria-label="Text display settings"
              id="views-button"
            >
              Views
            </button>
            <ul
              class="dropdown"
              role="menu"
              aria-labelledby="views-button"
              id="views-menu"
            >
              {
                Object.keys(
                  (isRootText
                    ? bilaraData.variant_text
                    : bilaraData.comment_text) || {}
                ).length > 0 && (
                  <>
                    <li role="menuitem">
                      <label for="commenter">Show comments</label>
                      <input
                        type="checkbox"
                        id="commenter"
                        checked
                        aria-controls="commenter-inline"
                      />
                    </li>
                    <li role="menuitem">
                      <label for="commenter-inline">↳ Inline</label>
                      <input
                        type="checkbox"
                        id="commenter-inline"
                        aria-controls="commenter-side"
                      />
                    </li>
                    <li role="menuitem">
                      <label for="commenter-side">↳ Side by side</label>
                      <input type="checkbox" id="commenter-side" />
                    </li>
                  </>
                )
              }
              {
                isSegmented && !isRootText && (
                  <>
                    <li role="menuitem">
                      <label for="rooter">Show root text</label>
                      <input
                        type="checkbox"
                        id="rooter"
                        aria-controls="rooter-first rooter-side"
                      />
                    </li>
                    <li role="menuitem">
                      <label for="rooter-first">↳ Root first</label>
                      <input type="checkbox" id="rooter-first" />
                    </li>
                    <li role="menuitem">
                      <label for="rooter-side">↳ Side by side</label>
                      <input type="checkbox" id="rooter-side" />
                    </li>
                  </>
                )
              }
              {
                (isSegmented ||
                  suttasData.translation.text.includes("class='ref")) && (
                  <li role="menuitem">
                    <label for="segmenter">Show segments</label>
                    <input type="checkbox" id="segmenter" />
                  </li>
                )
              }
              <li role="menuitem">
                <label for="positioner">Pin this menu</label>
                <input type="checkbox" id="positioner" checked />
              </li>
            </ul>
          </li>
          <li>
            <button popovertarget="parallels" aria-label="Show parallel texts">
              Parallels
            </button>
          </li>
          <li>
            <button
              aria-haspopup="menu"
              aria-expanded="false"
              aria-controls="listen-menu"
              aria-label="Text to speech settings"
              id="listen-menu-button"
            >
              Listen
            </button>
            <ul
              class="dropdown"
              role="menu"
              aria-labelledby="listen-menu-button"
              id="listen-menu"
            >
              <li>
                <noscript>
                  Please enable javascript to listen to this text. It works 100%
                  locally in your browser via the SpeechSynthesis API, including
                  while offline.
                </noscript>
              </li>
              <li role="menuitem" class="tts-controls">
                <button id="prev" type="button">
                  <span>⏮️</span><span>Prev</span>
                </button>
                <button id="playpause" type="button">
                  <span>▶️</span><span>Play</span>
                </button>
                <button id="stop" type="button">
                  <span>⏹️</span><span>Stop</span>
                </button>
                <button id="next" type="button">
                  <span>⏭️</span><span>Next</span>
                </button>
              </li>
              <li role="menuitem">
                <label for="voice-select">Voice</label>
                <select id="voice-select"></select>
              </li>
              <li role="menuitem">
                <label for="rate">Rate</label>
                <input
                  type="range"
                  min="0.5"
                  max="2"
                  value="1"
                  step="0.1"
                  id="rate"
                />
                <div id="rate-value">1.0</div>
              </li>
              <li role="menuitem">
                <label for="pitch">Pitch</label>
                <input
                  type="range"
                  min="0"
                  max="2"
                  value="1"
                  step="0.1"
                  id="pitch"
                />
                <div id="pitch-value">1.0</div>
              </li>
              <li role="menuitem">
                <label for="auto-scroll">Auto-scroll</label>
                <input type="checkbox" id="auto-scroll" />
              </li>
            </ul>
          </li>
        </ul>
      </fieldset>
    </aside>

    <Fragment set:html={articleHTML} />
    <Fragment set:html={commentsHtml} />

    {
      !!publicationData && !publicationData.error && (
        <PublicationInfo entry={publicationData} />
      )
    }

    <article id="parallels" popover>
      <TextMetaContent
        data={suttaplexData[0]}
        chosenLanguage={siteLanguage}
        title="Test"
        parallelsOpen
      />
    </article>
  </main>
</Layout>
